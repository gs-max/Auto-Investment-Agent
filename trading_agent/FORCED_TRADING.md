# ⚡ 强制交易模式说明

## 🎯 核心改变

**LLM 现在被强制每次都必须做出买入或卖出决策，完全禁止观望（hold）！**

---

## ✅ 已完成的修改

### 1️⃣ **Function Calling 定义**

**文件**: `src/advanced_nodes.py`

```python
# 修改前
"enum": ["buy", "sell", "hold", "close", "adjust_position"]

# 修改后
"enum": ["buy", "sell", "close"]
"description": "交易决策：buy=开多仓, sell=开空仓, close=平仓。禁止选择hold，必须每次都交易！"
```

**效果**: LLM 只能从 buy、sell、close 三个选项中选择。

---

### 2️⃣ **Context 提示强化**

在发送给 LLM 的提示中添加：

```
⚠️ 重要：你必须每次都做出交易决策！
- 禁止选择 hold 或观望
- 必须选择 buy（做多）或 sell（做空）或 close（平仓）
- 即使信号不明确，也要基于技术指标做出方向性选择
- 可以用小仓位 + 低杠杆来降低风险，但不能不交易

请基于以上数据立即做出交易决策。
```

---

### 3️⃣ **Hold 拦截转换**

**正常返回拦截**:
```python
decision = function_args.get("decision", "buy")
# 强制：如果LLM返回hold，自动转换为buy
if decision == "hold" or decision == "adjust_position":
    logger.warning(f"LLM试图返回 {decision}，强制改为 buy")
    decision = "buy"
state["trading_decision"] = decision
```

**备用方案（未使用 Function Calling）**:
```python
# 强制买入
state["trading_decision"] = "buy"
state["target_coin"] = "BTC"
state["target_size"] = 0.001
state["target_leverage"] = 1
state["use_tpsl"] = True
state["take_profit_pct"] = 3.0
state["stop_loss_pct"] = 1.5
state["reasoning"] = "LLM未正常返回，执行保守买入策略"
```

**异常处理**:
```python
except Exception as e:
    logger.error(f"LLM 分析失败: {e}，强制执行买入")
    # 强制小额买入
    state["trading_decision"] = "buy"
    state["target_size"] = 0.001
    state["target_leverage"] = 1
    # ... 设置止盈止损
```

---

### 4️⃣ **执行节点拦截**

```python
# 强制交易模式：不再处理hold
if decision == "hold":
    logger.warning("检测到 hold 决策，强制转换为小额买入")
    decision = "buy"
    size = 0.001
    leverage = 1
    use_tpsl = True
```

---

### 5️⃣ **策略提示词更新**

**文件**: `config/aggressive_strategy_prompt.txt`

**开头强制规则**:
```
## ⚠️ 强制规则（最重要！）

你必须每次都做出交易决策，禁止选择 hold！

- ✅ 只能选择：buy（做多）、sell（做空）、close（平仓）
- ❌ 禁止选择：hold、观望、等待
- ✅ 即使信号不明确，也必须基于技术指标做出方向性选择

记住：系统不允许你返回 hold，如果你试图观望，系统会强制执行买入！
```

**更新所有示例**:
- 示例1: 轻微上涨 → 必须买入
- 示例2: "异常"高价 → 必须做空
- 示例3: 无明确信号 → 强制小仓位试探
- 示例4: 持仓盈利 → 立即平仓
- 示例5: 完全平仓后 → 立即寻找新机会

---

## 🔄 工作流程

```
LLM 分析
    ↓
尝试返回决策
    ↓
┌─────────────────┐
│ 系统检查        │
│ decision == ?   │
└─────────────────┘
    ↓
┌───────────────────────────────┐
│ buy  → ✅ 通过，执行买入      │
│ sell → ✅ 通过，执行卖出      │
│ close → ✅ 通过，执行平仓     │
│ hold → ❌ 拦截！强制转为 buy   │
│ 其他 → ❌ 拦截！强制转为 buy   │
└───────────────────────────────┘
    ↓
执行交易
    ↓
记录日志
```

---

## 📊 实际效果

### **场景 1: LLM 尝试观望**

```
LLM 输出:
{
  "decision": "hold",
  "reasoning": "信号不明确，建议观望"
}

系统拦截:
⚠️ LLM试图返回 hold，强制改为 buy

最终执行:
{
  "decision": "buy",
  "coin": "BTC",
  "size": 0.001,
  "leverage": 1,
  "reasoning": "信号不明确，建议观望（系统强制转为小额买入）"
}
```

### **场景 2: 完全中性市场**

```
市场数据:
BTC: $65,000
RSI: 50（完全中性）
24h: 0%（无变化）

LLM 决策（被迫选择）:
{
  "decision": "buy",
  "coin": "BTC",
  "size": 0.005,
  "leverage": 1,
  "use_tpsl": true,
  "take_profit_pct": 2.0,
  "stop_loss_pct": 1.0,
  "reasoning": "所有指标完全中性，这是信号最不明确的情况。但系统禁止观望，必须选择方向。使用极小仓位试探，严格止损",
  "confidence": 0.4
}
```

### **场景 3: 异常处理**

```
LLM 分析失败（网络错误、超时等）

系统自动执行:
{
  "decision": "buy",
  "coin": "BTC",
  "size": 0.001,
  "leverage": 1,
  "use_tpsl": true,
  "take_profit_pct": 2.0,
  "stop_loss_pct": 1.0,
  "reasoning": "分析失败，执行最小风险买入"
}
```

---

## 🎯 强制交易策略

### **信号强度 → 仓位大小**

| 信号强度 | 决策 | 仓位 | 杠杆 | 说明 |
|---------|------|------|------|------|
| **强烈** (RSI<30 或 >70) | buy/sell | 0.01-0.05 | 5-10x | 大胆交易 |
| **一般** (有方向性指标) | buy/sell | 0.005-0.01 | 2-5x | 正常交易 |
| **弱** (信号不明确) | buy/sell | 0.001-0.005 | 1-2x | 试探交易 |
| **完全中性** (RSI=50, 24h=0%) | buy | 0.001 | 1x | 最小试探 |

### **风险控制**

虽然强制交易，但仍有保护：

```
✅ 强制止盈止损：
- 每笔交易必须设置 TP/SL
- 止盈: 2-5%
- 止损: 1-2%

✅ 仓位限制：
- 信号弱 → 小仓位（0.001）
- 最大风险 ≤ 账户的 2%

✅ 杠杆控制：
- 不确定 → 1x（等于无杠杆）
- 一般信号 → 2-3x
- 强信号 → 5-10x

✅ 快速止损：
- 亏损达 1-2% 立即止损
- 不死扛，不加仓
```

---

## 📈 预期交易行为

### **每小时**
```
检查次数: 60次（每分钟1次）
产生交易: 1-3笔
决策分布:
  - buy: 40%
  - sell: 30%
  - close: 30%
  - hold: 0%（完全禁用）
```

### **每天**
```
总检查: 1440次
总交易: 24-72笔
平均持仓时间: 20-40分钟
胜率目标: >55%
```

---

## ⚠️ 重要说明

### **这不是无脑交易**

虽然强制交易，但 LLM 仍会：

1. ✅ 分析技术指标
2. ✅ 判断市场趋势
3. ✅ 评估风险等级
4. ✅ 选择合适的币种
5. ✅ 调整仓位大小
6. ✅ 设置杠杆倍数
7. ✅ 配置止盈止损

**唯一区别**: 不能选择"不交易"

### **安全机制**

```
1. 止损保护
   - 每笔 1-2% 严格止损
   - 自动触发，无需人工

2. 仓位控制
   - 信号弱 → 仓位小
   - 单笔最多 $200

3. 杠杆限制
   - 最大 10x
   - 不确定时用 1x

4. 风险管理器
   - 多层检查
   - 异常拦截
```

---

## 🚀 如何运行

```bash
# 系统已默认启用强制交易模式
python main_advanced.py

# 查看日志（会看到 hold 被拦截）
tail -f logs/advanced_trading.log | grep "强制"
```

**预期日志**:
```
⚠️ LLM试图返回 hold，强制改为 buy
检测到 hold 决策，强制转换为小额买入
[真实] 买入 0.001 BTC, 1x杠杆
✅ 交易执行成功
```

---

## 📊 监控关键指标

```bash
# 统计 hold 被拦截次数
grep "强制改为 buy" logs/advanced_trading.log | wc -l

# 查看所有决策
grep "决策:" logs/advanced_trading.log

# 统计交易频率
grep "真实.*买入\|真实.*卖出" logs/advanced_trading.log | wc -l
```

---

## 🎓 与保守模式对比

| 特性 | 保守模式（旧） | 强制交易模式（新） |
|------|---------------|------------------|
| **hold 选项** | ✅ 可用 | ❌ 完全禁用 |
| **信号不明确时** | 观望 | 小仓位试探 |
| **异常情况** | 等待 | 最小风险买入 |
| **交易频率** | 低（20%交易） | 高（100%交易） |
| **决策速度** | 慢（等信号） | 快（立即决策） |
| **风险控制** | 谨慎（不交易） | 灵活（小仓位+止损） |

---

## 💡 最佳实践

### **信号不明确时**

```
❌ 错误：尝试返回 hold
✅ 正确：
{
  "decision": "buy",
  "size": 0.001,      // 最小仓位
  "leverage": 1,       // 无杠杆
  "use_tpsl": true,
  "take_profit_pct": 2.0,  // 小止盈
  "stop_loss_pct": 1.0,    // 严格止损
  "reasoning": "信号不明确，使用极小仓位试探市场，风险可控"
}
```

### **刚完成交易后**

```
❌ 错误：想要休息，返回 hold
✅ 正确：
- 立即扫描其他币种
- 寻找新的交易机会
- 切换到不同策略（做多→做空）
```

### **市场完全平静时**

```
❌ 错误：等待波动，返回 hold
✅ 正确：
- 选择波动率相对较高的币种
- 使用最小仓位（0.001）
- 设置紧密止损（1%）
- 快速进出
```

---

## 🎯 总结

### **核心改变**
- ✅ 完全禁用 hold
- ✅ 强制每次交易
- ✅ 多层拦截机制
- ✅ 保留风险控制

### **三个选项**
1. **buy** - 开多仓（看涨时用）
2. **sell** - 开空仓（看跌时用）
3. **close** - 平仓（获利或止损）

### **如果尝试 hold**
```
System → ❌ 拦截
System → 🔄 转换为 buy
System → 📝 记录日志
System → ✅ 执行小额买入
```

### **风险管理**
```
强制交易 ≠ 无脑交易
每笔都有：
✅ 止盈止损
✅ 仓位控制
✅ 杠杆限制
✅ 快速止损
```

---

**现在你的 Agent 是一个真正的高频交易员，永远在市场中，从不观望！** ⚡📈
